# UOne Data Scraping
A Python package for UOne Data Scraping projects, including a Lambda Layer which can be
included in other Lambdas.

# Deploying
Make sure to manually incriment the current layer version to what the current layer version is
by going to the aws console, going to lambda layers and looking for this layer's current version
and then puting that value in the app.py file for the layer version....fml, right?


This project is deployed via a CDK pipeline.
If you somehow got this code without `git clone`ing it from somewhere, then you can
bootstrap one of your own by doing:

    $ nvm use 16.5 # or however you manage your Node versions
    $ npm install aws-cdk # or however you install AWS CDK
    $ pyenv local 3.8.9 # or however you manage Python versions
    $ pyenv rehash # more of ^
    $ . venv/bin/activate # or however you manage your Python dependencies
    $ pip install -r requirements.txt # more of ^
    # if you have SSO...
        $ aws-vault exec <your profile> # or however log in with SSO
        $ yawsso --profile <your profile> # or however you make CDK work
    $ cdk deploy --profile <your profile> -c env=<your profile>


## Generate parameters for certain workflows; e.g. RESTful API calls to HTTP(s) endpoints
## Scrape APIs using those params that were generated by this package

### Local Development
#### Run Tests

    $ docker build --rm -t uone_scraper --target=tester . \
    && docker run -it --rm uone_scraper pytest

### Deploy
Run the once to deploy a self-mutating, repo-watching super CICD to deploy the
actual package and Layer

    # Deploy to the Shared Services AWS account only :) 1 copy of your code
    ##################################
    # !!! FIRST TIME DEPLOY ONLY !!! #
    ##################################
    $ cdk deploy --profile shared -c env=shared

    # Bump the version of the python package, so we can `pip install` a new version.
    # The package follows semantic versioning of `<major>.<minor>.<patch>[-<release><build>]`.
    # So if you have a `major` change, use `bump2version major`.  If you have a `minor` change,
    # use `bump2version minor` and so on.  From here, you'll have a `build` tag on your
    $ git add .
    $ git commit -m 'Do a cool new thing'
    $ bump2version <the type of version bump you want to do>
    $ git push

## Notes
- Docker image is from (gallery.ecr.aws/bitnami/python)[https://gallery.ecr.aws/bitnami/python].  This is a public AWS image hosting thing called "Gallery".  It's like Docker hub except we get rate limited on Docker hub.




Once the virtualenv is activated, you can install the required dependencies.

```
$ pip install -r requirements.txt
```

At this point you can now synthesize the CloudFormation template for this code.

```
$ cdk synth
```

To add additional dependencies, for example other CDK libraries, just add
them to your `setup.py` file and rerun the `pip install -r requirements.txt`
command.

## Useful commands

 * `cdk ls`          list all stacks in the app
 * `cdk synth`       emits the synthesized CloudFormation template
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk docs`        open CDK documentation

Enjoy!
